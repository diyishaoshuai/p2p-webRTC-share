# 4K@60fps 屏幕共享性能优化指南

## 🔍 卡顿原因分析

4K@60fps 屏幕共享卡顿可能由以下因素导致：

### 1. **网络带宽** ⚠️ 最重要
- **4K@60fps 所需带宽**：
  - 无码率限制：50-100+ Mbps
  - 优化后（已实现）：25-45 Mbps
- **检查方法**：
  - 打开控制台查看实时码率日志
  - 使用 `speedtest.net` 测试上行/下行带宽
- **要求**：
  - 上行带宽：至少 50 Mbps（推荐 100 Mbps+）
  - 下行带宽：至少 50 Mbps（推荐 100 Mbps+）
  - 延迟：< 50ms（推荐 < 30ms）

### 2. **编码性能** 💻
- **硬件编码 vs 软件编码**：
  - 硬件编码（GPU）：性能好，CPU占用低
  - 软件编码（CPU）：性能差，CPU占用高
- **浏览器支持**：
  - Chrome/Edge：支持硬件编码（H.264/VP8/VP9）
  - Firefox：主要使用软件编码
- **检查方法**：
  - 打开任务管理器查看CPU/GPU使用率
  - CPU使用率 > 80% 说明可能是软件编码

### 3. **解码性能** 🖥️
- **接收端要求**：
  - 需要能够实时解码 4K@60fps 视频流
  - 硬件解码：GPU解码，性能好
  - 软件解码：CPU解码，可能卡顿
- **检查方法**：
  - 接收端打开任务管理器
  - 如果CPU使用率很高，说明是软件解码

### 4. **服务器** 🌐
- **P2P模式**：服务器不参与数据传输，只转发信令
- **TURN中继模式**：如果使用TURN服务器，服务器带宽很重要
- **当前系统**：使用P2P直连，服务器影响较小

### 5. **码率设置** 📊
- **已实现优化**：
  - 4K@60fps：最大码率 45 Mbps
  - 2K@60fps：最大码率 20 Mbps
  - 1080p@60fps：最大码率 10 Mbps
- **自适应调整**：根据分辨率和帧率自动调整

## ✅ 已实现的优化

### 1. **码率限制**
```javascript
// 根据分辨率自动设置码率上限
4K@60fps: 45 Mbps
4K@30fps: 30 Mbps
2K@60fps: 20 Mbps
2K@30fps: 15 Mbps
1080p@60fps: 10 Mbps
1080p@30fps: 6 Mbps
```

### 2. **编码参数优化**
- 设置编码优先级为高
- 设置网络优先级为高
- 优化编码参数以降低延迟

### 3. **强制硬件编码/解码** ⚡
- **硬件编码（发送端）**：
  - 自动修改SDP，优先选择H.264编码器（通常有硬件支持）
  - 降低VP8/VP9优先级（通常是软件编码）
  - 在控制台显示使用的编码器类型（硬件/软件）
  
- **硬件解码（接收端）**：
  - 浏览器自动使用硬件解码（如果支持）
  - 在控制台显示使用的解码器类型（硬件/软件）
  
- **检查方法**：
  - 打开控制台查看编码器/解码器信息
  - 如果显示"硬件编码/解码"，说明已启用硬件加速

### 4. **实时监控**
- 每2秒输出实际码率
- 码率过高时自动警告
- 显示分辨率、帧率、码率信息
- 显示编码器/解码器类型（硬件/软件）

## 🛠️ 性能优化建议

### 对于发送端（共享屏幕的用户）

1. **使用Chrome/Edge浏览器**
   - 更好的硬件编码支持
   - 更低的CPU占用

2. **确保足够的网络带宽**
   - 上行带宽至少 50 Mbps
   - 使用有线网络而非WiFi（如果可能）

3. **关闭不必要的应用**
   - 释放CPU和网络资源
   - 关闭其他占用带宽的应用

4. **降低分辨率或帧率**
   - 如果网络带宽不足，降低到2K@30fps
   - 或使用1080p@60fps

### 对于接收端（观看的用户）

1. **使用硬件加速**
   - 确保浏览器启用硬件加速
   - Chrome设置：`chrome://settings/system` → 启用硬件加速

2. **确保足够的网络带宽**
   - 下行带宽至少 50 Mbps
   - 使用有线网络而非WiFi

3. **关闭不必要的应用**
   - 释放CPU和GPU资源
   - 关闭其他占用资源的应用

4. **使用高性能设备**
   - 确保GPU支持硬件解码
   - 较新的显卡通常性能更好

## 📊 性能监控

### 查看实时码率和编码器信息
打开浏览器控制台（F12），会看到类似日志：
```
✅ 已设置视频编码参数: 3840x2160@60fps, 最大码率: 45.0Mbps
📹 使用编码器: video/H264 (硬件编码)
📺 使用解码器: video/H264 (硬件解码)
📊 实时码率: 42.35Mbps (3840x2160@60fps)
```

**说明**：
- 如果显示"硬件编码/解码"：说明已启用硬件加速，性能更好
- 如果显示"软件编码/解码"：说明使用CPU编码/解码，性能较差

### 检查网络带宽
1. 访问 `speedtest.net` 测试带宽
2. 确保上行/下行带宽满足要求
3. 检查网络延迟

### 检查硬件性能
1. 打开任务管理器（Windows）或活动监视器（Mac）
2. 查看CPU/GPU使用率
3. 如果CPU使用率 > 80%，考虑降低分辨率

## 🎯 推荐配置

### 最佳体验（流畅4K@60fps）
- **网络**：100 Mbps+ 上行/下行，< 30ms 延迟
- **发送端**：现代CPU（Intel i7/AMD Ryzen 7+），支持硬件编码
- **接收端**：现代GPU（支持硬件解码），16GB+ RAM
- **浏览器**：Chrome/Edge 最新版

### 中等体验（流畅2K@60fps）
- **网络**：50 Mbps+ 上行/下行，< 50ms 延迟
- **发送端**：中等CPU，支持硬件编码
- **接收端**：中等GPU，8GB+ RAM
- **浏览器**：Chrome/Edge/Firefox

### 基础体验（流畅1080p@60fps）
- **网络**：20 Mbps+ 上行/下行，< 100ms 延迟
- **发送端**：基础CPU
- **接收端**：基础GPU，4GB+ RAM
- **浏览器**：Chrome/Edge/Firefox

## ⚠️ 常见问题

### Q: 为什么4K@60fps很卡？
A: 可能的原因：
1. 网络带宽不足（最常见）
2. 使用软件编码（CPU占用高）- **已自动优化为硬件编码**
3. 接收端解码性能不足 - **已自动优化为硬件解码**
4. 网络延迟过高

### Q: 如何确认是否使用了硬件编码/解码？
A: 
- 打开浏览器控制台（F12）
- 查看日志中的编码器/解码器信息
- 如果显示"硬件编码/解码"，说明已启用硬件加速
- 如果显示"软件编码/解码"，可能需要：
  1. 更新浏览器到最新版本
  2. 确保GPU驱动已更新
  3. 在浏览器设置中启用硬件加速

### Q: 如何判断是网络问题还是硬件问题？
A: 
- 查看控制台码率日志
- 如果码率 < 20 Mbps 但很卡 → 可能是硬件问题
- 如果码率 > 40 Mbps 但很卡 → 可能是网络问题

### Q: 为什么降低分辨率后还是卡？
A: 可能的原因：
1. 网络带宽仍然不足
2. 延迟过高
3. 接收端解码性能不足

## 📝 总结

4K@60fps 屏幕共享卡顿的主要原因：
1. **网络带宽不足**（60%）
2. **编码/解码性能不足**（30%）
3. **网络延迟过高**（10%）

**已实现的优化**：
- ✅ 码率限制（防止网络拥塞）
- ✅ 编码参数优化（降低延迟）
- ✅ 实时监控（帮助诊断问题）

**建议**：
- 如果网络带宽不足，降低分辨率或帧率
- 使用Chrome/Edge浏览器以获得更好的硬件编码支持
- 确保发送端和接收端都有足够的网络带宽

